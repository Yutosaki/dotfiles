{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
{{ else -}}
#!/bin/zsh
{{ end -}}

# rootæ¨©é™ãƒã‚§ãƒƒã‚¯ç”¨
SUDO_CMD=""
if [ "$(id -u)" -ne 0 ]; then
    SUDO_CMD="sudo"
fi

echo "ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™..."

# -----------------------------------------------------------------------------
# 1. OSã”ã¨ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‡¦ç† (Linux / Darwin)
# -----------------------------------------------------------------------------
{{ if eq .chezmoi.os "linux" -}}
echo "ğŸ§ Linuxç”¨ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œä¸­..."

# å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ç„¡åŠ¹åŒ– & ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®š
export DEBIAN_FRONTEND=noninteractive
if [ ! -f /etc/localtime ]; then
    echo "â° ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’ Asia/Tokyo ã«è¨­å®š..."
    $SUDO_CMD ln -fs /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
    echo "Asia/Tokyo" | $SUDO_CMD tee /etc/timezone
    $SUDO_CMD dpkg-reconfigure --frontend noninteractive tzdata
fi

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–° & å¿…é ˆãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$SUDO_CMD apt-get update
$SUDO_CMD apt-get install -y \
    build-essential unzip valgrind git curl zsh tmux tzdata \
    ripgrep bat lsd

# Ubuntuã®batcatå¯¾å¿œ
if command -v batcat &> /dev/null && ! command -v bat &> /dev/null; then
    mkdir -p ~/.local/bin
    ln -s /usr/bin/batcat ~/.local/bin/bat
    export PATH="$HOME/.local/bin:$PATH"
fi

# --- Neovim (Linux: GitHubã‹ã‚‰ãƒã‚¤ãƒŠãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰) ---
if ! command -v nvim &> /dev/null; then
    echo "ğŸŒ‘ Neovim (Linux Binary) ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux64.tar.gz
    $SUDO_CMD rm -rf /opt/nvim
    $SUDO_CMD tar -C /opt -xzf nvim-linux64.tar.gz
    $SUDO_CMD ln -sf /opt/nvim-linux64/bin/nvim /usr/local/bin/nvim
    rm nvim-linux64.tar.gz
    echo "âœ… Neovim installed."
else
    echo "âœ… Neovim is already installed."
fi

{{ else if eq .chezmoi.os "darwin" -}}
echo "ğŸ macOSç”¨ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œä¸­..."

if ! command -v brew &> /dev/null; then
    echo "ğŸº Homebrew not found. Skipping brew install."
else
    brew update
    # Neovimã‚’å«ã‚ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    brew install lsd bat ripgrep tmux neovim
fi
{{ end -}}

# -----------------------------------------------------------------------------
# 2. Rust (Cargo) & å…±é€šãƒ„ãƒ¼ãƒ«
# -----------------------------------------------------------------------------
if ! command -v cargo &> /dev/null; then
    echo "ğŸ¦€ Rustã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
fi

# CargoçµŒç”±ã§ã®ãƒ„ãƒ¼ãƒ«è£œå®Œ (OSã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ã§å…¥ã‚‰ãªã‹ã£ãŸå ´åˆã®ã¿)
if ! command -v rg &> /dev/null; then cargo install ripgrep; fi
if ! command -v lsd &> /dev/null; then cargo install lsd; fi
if ! command -v bat &> /dev/null; then cargo install bat; fi

# -----------------------------------------------------------------------------
# 3. Zshãƒ—ãƒ©ã‚°ã‚¤ãƒ³ & FZF
#    (ä¿å­˜å…ˆ: ~/.local/share/zsh/plugins)
# -----------------------------------------------------------------------------
ZSH_PLUGIN_DIR="$HOME/.local/share/zsh/plugins"
mkdir -p "$ZSH_PLUGIN_DIR"

clone_if_not_exists() {
    REPO_URL=$1; DEST_DIR=$2
    if [ ! -d "$DEST_DIR" ]; then 
        echo "â¬‡ï¸ Cloning $DEST_DIR..."
        git clone --depth 1 "$REPO_URL" "$DEST_DIR"
    fi
}

clone_if_not_exists "https://github.com/zsh-users/zsh-syntax-highlighting.git" "$ZSH_PLUGIN_DIR/zsh-syntax-highlighting"
clone_if_not_exists "https://github.com/zsh-users/zsh-autosuggestions" "$ZSH_PLUGIN_DIR/zsh-autosuggestions"
clone_if_not_exists "https://github.com/Aloxaf/fzf-tab" "$ZSH_PLUGIN_DIR/fzf-tab"

# FZFæœ¬ä½“ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
FZF_DIR="$HOME/.fzf"
if [ ! -d "$FZF_DIR" ]; then
    git clone --depth 1 https://github.com/junegunn/fzf.git "$FZF_DIR"
    "$FZF_DIR/install" --all --no-bash --no-fish
fi

# -----------------------------------------------------------------------------
# 4. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ã‚§ãƒ«å¤‰æ›´
# -----------------------------------------------------------------------------
ZSH_PATH=$(which zsh)
if [ -n "$ZSH_PATH" ] && [ "$SHELL" != "$ZSH_PATH" ]; then
    echo "ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ã‚§ãƒ«ã‚’zshã«å¤‰æ›´ã—ã¾ã™..."
    chsh -s "$ZSH_PATH"
fi

echo "âœ¨ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼"
