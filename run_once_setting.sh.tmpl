{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
{{ else -}}
#!/bin/zsh
{{ end -}}

# ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚‰å³åº§ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’åœæ­¢ã™ã‚‹
set -e

# rootæ¨©é™ãƒã‚§ãƒƒã‚¯
SUDO_CMD=""
if [ "$(id -u)" -ne 0 ]; then
    SUDO_CMD="sudo"
fi

echo "ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™..."

# -----------------------------------------------------------------------------
# 1. Linuxç”¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (ãƒ­ã‚±ãƒ¼ãƒ«ãƒ»ãƒ„ãƒ¼ãƒ«ãƒ»Neovim)
# -----------------------------------------------------------------------------
{{ if eq .chezmoi.os "linux" -}}
echo "ğŸ§ Linuxç”¨ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œä¸­..."
export DEBIAN_FRONTEND=noninteractive

# å¿…é ˆãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
$SUDO_CMD apt-get update
$SUDO_CMD apt-get install -y \
    build-essential unzip valgrind git curl zsh tmux tzdata locales \
    ripgrep bat lsd nodejs npm

# ãƒ­ã‚±ãƒ¼ãƒ«ç”Ÿæˆ (LC_ALLã‚¨ãƒ©ãƒ¼å¯¾ç­–)
if ! command -v locale-gen &> /dev/null; then
    $SUDO_CMD apt-get update
    $SUDO_CMD apt-get install -y locales
fi
# en_US.UTF-8 ãŒãªã„å ´åˆã¯ç”Ÿæˆ
if ! grep -q "en_US.UTF-8" /etc/locale.gen; then
    echo "en_US.UTF-8 UTF-8" | $SUDO_CMD tee -a /etc/locale.gen
fi
$SUDO_CMD locale-gen en_US.UTF-8

# ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®š
if [ ! -f /etc/localtime ]; then
    echo "â° ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’ Asia/Tokyo ã«è¨­å®š..."
    $SUDO_CMD ln -fs /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
    echo "Asia/Tokyo" | $SUDO_CMD tee /etc/timezone
    $SUDO_CMD dpkg-reconfigure --frontend noninteractive tzdata
fi

# batcatå¯¾å¿œ
if command -v batcat &> /dev/null && ! command -v bat &> /dev/null; then
    mkdir -p ~/.local/bin
    ln -s /usr/bin/batcat ~/.local/bin/bat
    export PATH="$HOME/.local/bin:$PATH"
fi

# --- Neovim (ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è‡ªå‹•åˆ¤å®š) ---
if ! command -v nvim &> /dev/null; then
    echo "ğŸŒ‘ Installing Neovim $NVIM_VERSION ..."
    
    NVIM_VERSION="v0.10.4"

    # ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ¤å®š (x86_64 or aarch64)
    ARCH=$(uname -m)
    NVIM_ASSET="nvim-linux64.tar.gz"
    
    if [ "$ARCH" = "aarch64" ]; then
        echo "   ğŸ‘‰ Detected ARM64 architecture."
        NVIM_ASSET="nvim-linux-arm64.tar.gz"
    else
        echo "   ğŸ‘‰ Detected x86_64 architecture."
    fi

    # URLã‚’å®šç¾©
    URL="https://github.com/neovim/neovim/releases/download/${NVIM_VERSION}/${NVIM_ASSET}"
    echo "â¬‡ï¸ Downloading from: $URL"

    # -L: ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è¿½è·¡
    # -f: ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼(404ç­‰)ãªã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã›ãšã«å¤±æ•—ã•ã›ã‚‹
    # -O: ã‚µãƒ¼ãƒãƒ¼ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«åã§ä¿å­˜
    curl -L -f -O "$URL"
    
    # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—ãƒã‚§ãƒƒã‚¯
    if [ $? -ne 0 ]; then
        echo "âŒ Download failed! URL or Network issue."
        exit 1
    fi

    $SUDO_CMD rm -rf /opt/nvim
    # è§£å‡ (tarã®ã‚¨ãƒ©ãƒ¼é˜²æ­¢ã®ãŸã‚ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³èª¿æ•´)
    $SUDO_CMD tar -C /opt -xzf "$NVIM_ASSET"
    
    # ãƒ•ã‚©ãƒ«ãƒ€åãŒã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã‚ˆã£ã¦ç•°ãªã‚‹ãŸã‚ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã§ãƒªãƒ³ã‚¯
    $SUDO_CMD ln -sf /opt/nvim-linux*/bin/nvim /usr/local/bin/nvim
    
    rm "$NVIM_ASSET"
    echo "âœ… Neovim installed."
else
    echo "âœ… Neovim is already installed."
fi

{{ else if eq .chezmoi.os "darwin" -}}
# -----------------------------------------------------------------------------
# 2. macOSç”¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
# -----------------------------------------------------------------------------
echo "ğŸ macOSç”¨ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œä¸­..."
if ! command -v brew &> /dev/null; then
    echo "ğŸº Homebrew not found. Skipping brew install."
else
    echo "ğŸº Updating Homebrew..."
    brew update || true

    echo "ğŸº Installing packages..."
    brew install lsd bat ripgrep tmux neovim node || true
fi
    
# "/Applications/Karabiner-Elements.app" ã¨ã„ã†ãƒ•ã‚©ãƒ«ãƒ€ãŒãªã„å ´åˆã®ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
if [ ! -d "/Applications/Karabiner-Elements.app" ]; then
    echo "âŒ¨ï¸ Installing Karabiner-Elements..."
    brew install --cask karabiner-elements || ture
else
    echo "âœ… Karabiner-Elements is already installed."
fi
{{ end -}}

# -----------------------------------------------------------------------------
# 3. å…±é€šå‡¦ç†: Rust & Zshãƒ—ãƒ©ã‚°ã‚¤ãƒ³
# -----------------------------------------------------------------------------
if ! command -v cargo &> /dev/null; then
    echo "ğŸ¦€ Rustã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
fi

if ! command -v rg &> /dev/null; then cargo install ripgrep; fi
if ! command -v lsd &> /dev/null; then cargo install lsd; fi
if ! command -v bat &> /dev/null; then cargo install bat; fi

# Zshãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä¿å­˜å…ˆ
ZSH_PLUGIN_DIR="$HOME/.local/share/zsh/plugins"
mkdir -p "$ZSH_PLUGIN_DIR"

clone_if_not_exists() {
    REPO_URL=$1; DEST_DIR=$2
    if [ ! -d "$DEST_DIR" ]; then 
        echo "â¬‡ï¸ Cloning $DEST_DIR..."
        git clone --depth 1 "$REPO_URL" "$DEST_DIR"
    fi
}

clone_if_not_exists "https://github.com/zsh-users/zsh-syntax-highlighting.git" "$ZSH_PLUGIN_DIR/zsh-syntax-highlighting"
clone_if_not_exists "https://github.com/zsh-users/zsh-autosuggestions" "$ZSH_PLUGIN_DIR/zsh-autosuggestions"
clone_if_not_exists "https://github.com/Aloxaf/fzf-tab" "$ZSH_PLUGIN_DIR/fzf-tab"

FZF_DIR="$HOME/.fzf"
if [ ! -d "$FZF_DIR" ]; then
    git clone --depth 1 https://github.com/junegunn/fzf.git "$FZF_DIR"
    "$FZF_DIR/install" --all --no-bash --no-fish
fi

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ã‚§ãƒ«ã‚’ Zsh ã«å¤‰æ›´ (GitHub Actionså¯¾ç­–ã§ sudo ã‚’ä½¿ç”¨)
ZSH_PATH=$(which zsh)
if [ "$SHELL" != "$(which zsh)" ]; then
    echo "ğŸš Changing default shell to zsh..."
    $SUDO_CMD chsh -s "$(which zsh)" "$CURRENT_USER"
fi

echo "âœ¨ Setup Complete!"
echo "âœ¨ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼"
